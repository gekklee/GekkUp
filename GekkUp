#!/bin/bash

# GekkUp - EndeavourOS update script

set -e

# Parse --noconfirm flag
NO_CONFIRM=false
if [[ "$1" == "--noconfirm" ]]; then
  NO_CONFIRM=true
fi

sudo -v

# Keep sudo alive
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

echo "-----------------------------------"
echo "Updating Flatpaks..."
echo "-----------------------------------"
flatpak update -y

echo "-----------------------------------"
echo "Refreshing package databases..."
echo "-----------------------------------"
yay -Syy --noconfirm

if [[ "$NO_CONFIRM" == false ]]; then
  echo "-----------------------------------"
  echo "Checking for package updates..."
  echo "-----------------------------------"
  yay -Qu || echo "All packages are up to date."

  echo
  read -rp "Proceed with full system upgrade? [Y/n] " answer
  answer="${answer,,}"
  if [[ "$answer" =~ ^(n|no)$ ]]; then
    echo "Update cancelled."
    exit 0
  fi
fi

echo "-----------------------------------"
echo "Performing system upgrade..."
echo "-----------------------------------"
yay -Syu --noconfirm

echo "-----------------------------------"
echo "System update complete."
echo "-----------------------------------"